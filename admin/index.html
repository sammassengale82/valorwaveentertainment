<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Valorwave CMS</title>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;700&family=Roboto+Condensed:wght@300;700&display=swap" rel="stylesheet">

  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* THEMES */

    body.original {
      background: #1b1b1b;
      color: #f5f5f5;
      font-family: Arial, sans-serif;
    }

    body.multicam {
      background: #2b2b2b;
      color: #f5f5f5;
      font-family: "Roboto Condensed", sans-serif;
    }

    body.patriotic {
      background: linear-gradient(180deg, #b22234 0%, #ffffff 50%, #3c3b6e 100%);
      color: #ffffff;
      font-family: "Merriweather", serif;
    }

    /* LAYOUT */

    body {
      display: flex;
      gap: 20px;
      padding: 20px;
      box-sizing: border-box;
    }

    #sidebar {
      width: 260px;
      border-right: 2px solid #3b3b3b;
      padding-right: 20px;
      padding: 15px;
      box-shadow: 0 0 10px #0007;
      background: rgba(0, 0, 0, 0.4);
    }

    #sidebar h3 {
      margin-top: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #ffd700;
    }

    #files button {
      display: block;
      width: 100%;
      margin-bottom: 6px;
      padding: 8px;
      text-align: left;
      cursor: pointer;
      border: 1px solid #444;
      background: #2b2b2b;
      color: #f5f5f5;
    }

    #files button:hover {
      background: #3b3b3b;
    }

    #mainArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #topRow {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #currentFileName {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #ff4c4c;
    }

    #toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .btn {
      padding: 6px 10px;
      cursor: pointer;
      font-size: 13px;
      border: 1px solid #555;
      background: #2b2b2b;
      color: #f5f5f5;
    }

    .btn:hover {
      background: #3b3b3b;
    }

    #themeSelect {
      min-width: 140px;
    }

    #autosaveIndicator {
      font-size: 12px;
      opacity: 0.8;
      margin-left: 10px;
    }

    #middleRow {
      display: flex;
      gap: 10px;
      height: 65vh;
    }

    #editorSplit {
      width: 60%;
      display: flex;
      gap: 10px;
    }

    #editor {
      width: 50%;
      height: 100%;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      background: #111;
      color: #f5f5f5;
      border: 1px solid #444;
      box-sizing: border-box;
    }

    #preview {
      width: 50%;
      height: 100%;
      padding: 10px;
      background: #101820;
      border: 1px solid #444;
      overflow: auto;
      box-sizing: border-box;
    }

    #livePreviewContainer {
      width: 40%;
      height: 100%;
      border: 2px solid #444;
      background: #000;
      box-shadow: 0 0 10px #0007;
      box-sizing: border-box;
    }

    #livePreview {
      width: 100%;
      height: 100%;
      border: 0;
    }

    #status {
      margin-top: 5px;
      font-weight: bold;
      color: #00ff9d;
    }

    #newFileModal {
      display: none;
      position: fixed;
      top: 20%;
      left: 40%;
      background: #202020;
      padding: 20px;
      border: 1px solid #aaa;
      box-shadow: 0 0 10px #000c;
      z-index: 1000;
      color: #f5f5f5;
      width: 260px;
    }

    #newFileModal input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background: #111;
      color: #f5f5f5;
      border: 1px solid #444;
      box-sizing: border-box;
    }

    #uploadInput {
      margin-top: 10px;
      margin-bottom: 10px;
      width: 100%;
    }

    .folder::before {
      content: "üìÅ ";
    }

    .file::before {
      content: "üìÑ ";
    }
  </style>
</head>
<body class="original">

<div id="sidebar">
  <h3>Valorwave CMS</h3>
  <button class="btn" onclick="loadFiles()">Reload Files</button>
  <button class="btn" onclick="showNewFileModal()">New File</button>
  <input type="file" id="uploadInput" onchange="uploadImage()" />
  <div id="files"></div>
</div>

<div id="mainArea">
  <div id="topRow">
    <div>
      <h3 id="currentFileName">No file selected</h3>
      <div id="toolbar">
        <button class="btn" onclick="insertMarkdown('**','**')">Bold</button>
        <button class="btn" onclick="insertMarkdown('*','*')">Italic</button>
        <button class="btn" onclick="insertHeading()">H1</button>
        <button class="btn" onclick="insertMarkdown('- ', '')">‚Ä¢ List</button>
        <button class="btn" onclick="insertMarkdown('1. ', '')">1. List</button>
        <button class="btn" onclick="insertLink()">Link</button>
        <button class="btn" onclick="insertImage()">Image</button>
        <button class="btn" onclick="saveFile()">Save</button>
        <button class="btn" onclick="deleteFile()">Delete</button>
        <button class="btn" onclick="refreshLivePreview()">Refresh Preview</button>
        <span id="autosaveIndicator">Autosave: Ready</span>
      </div>
    </div>
    <div>
      <select id="themeSelect" class="btn" onchange="changeTheme()">
        <option value="original">Original</option>
        <option value="multicam">Army Multicam</option>
        <option value="patriotic">Patriotic</option>
      </select>
    </div>
  </div>

  <div id="middleRow">
    <div id="editorSplit">
      <textarea id="editor" placeholder="Markdown editor..."></textarea>
      <div id="preview"></div>
    </div>
    <div id="livePreviewContainer">
      <iframe id="livePreview" src="/"></iframe>
    </div>
  </div>

  <input type="hidden" id="currentPath">
  <input type="hidden" id="currentSha">
  <input type="hidden" id="currentFolder" value="">

  <div id="status"></div>
</div>

<div id="newFileModal">
  <h3>Create New File</h3>
  <input id="newFilePath" placeholder="path/filename.md">
  <button class="btn" onclick="createNewFile()">Create</button>
  <button class="btn" onclick="hideNewFileModal()">Cancel</button>
</div>

<script>
let autosaveTimer = null;
let dirty = false;

function setStatus(msg, color) {
  const el = document.getElementById("status");
  el.textContent = msg;
  el.style.color = color || "#00ff9d";
}

function changeTheme() {
  const theme = document.getElementById("themeSelect").value;
  document.body.className = theme;
}

function refreshLivePreview() {
  const iframe = document.getElementById("livePreview");
  iframe.src = iframe.src;
}

function loadFiles(path = "") {
  const params = path ? `?path=${encodeURIComponent(path)}` : "";
  fetch("/api/files" + params)
    .then(res => res.json())
    .then(files => {
      const container = document.getElementById("files");
      container.innerHTML = "";

      if (path) {
        const upBtn = document.createElement("button");
        upBtn.textContent = "../";
        upBtn.classList.add("folder");
        upBtn.onclick = () => {
          const parts = path.split("/").filter(Boolean);
          parts.pop();
          const newPath = parts.join("/");
          loadFiles(newPath);
          document.getElementById("currentFolder").value = newPath;
        };
        container.appendChild(upBtn);
      }

      files.forEach(file => {
        const btn = document.createElement("button");
        if (file.type === "dir") {
          btn.textContent = file.name + "/";
          btn.classList.add("folder");
          btn.onclick = () => {
            const newPath = (path ? path + "/" : "") + file.name;
            document.getElementById("currentFolder").value = newPath;
            loadFiles(newPath);
          };
        } else {
          btn.textContent = file.name;
          btn.classList.add("file");
          btn.onclick = () => loadFile(file.path);
        }
        container.appendChild(btn);
      });
    });
}

function loadFile(path) {
  fetch(`/api/file?path=${encodeURIComponent(path)}`)
    .then(res => res.json())
    .then(data => {
      const decoded = atob(data.content || "");

      document.getElementById("editor").value = decoded;
      document.getElementById("currentPath").value = data.path;
      document.getElementById("currentSha").value = data.sha;
      document.getElementById("currentFileName").textContent = data.path;

      renderPreview();
      dirty = false;
      setStatus("Loaded " + data.path);
    });
}

function saveFile() {
  const path = document.getElementById("currentPath").value;
  const sha = document.getElementById("currentSha").value;
  const content = document.getElementById("editor").value;

  if (!path || !sha) {
    alert("No file loaded.");
    return;
  }

  fetch("/api/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ path, content, sha })
  })
  .then(res => res.json())
  .then(data => {
    if (data.commit) {
      setStatus("Saved " + path);
      if (data.content && data.content.sha) {
        document.getElementById("currentSha").value = data.content.sha;
      }
      dirty = false;
      document.getElementById("autosaveIndicator").textContent = "Autosave: Saved";
    } else {
      setStatus("Save failed", "#ff4c4c");
      document.getElementById("autosaveIndicator").textContent = "Autosave: Error";
    }
  });
}

function deleteFile() {
  const path = document.getElementById("currentPath").value;
  const sha = document.getElementById("currentSha").value;

  if (!path) {
    alert("No file selected");
    return;
  }

  if (!confirm("Delete " + path + "?")) return;

  fetch("/api/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ path, sha })
  })
  .then(res => res.json())
  .then(data => {
    setStatus("Deleted " + path, "#ff4c4c");
    const folder = document.getElementById("currentFolder").value;
    loadFiles(folder);
    document.getElementById("editor").value = "";
    document.getElementById("currentFileName").textContent = "No file selected";
    document.getElementById("currentPath").value = "";
    document.getElementById("currentSha").value = "";
    renderPreview();
  });
}

function showNewFileModal() {
  document.getElementById("newFileModal").style.display = "block";
}

function hideNewFileModal() {
  document.getElementById("newFileModal").style.display = "none";
}

function createNewFile() {
  const input = document.getElementById("newFilePath");
  let path = input.value.trim();
  const folder = document.getElementById("currentFolder").value;

  if (!path) {
    alert("Enter a file path");
    return;
  }

  if (folder) {
    path = folder.replace(/\/$/, "") + "/" + path;
  }

  fetch("/api/new", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ path, content: "" })
  })
  .then(res => res.json())
  .then(data => {
    hideNewFileModal();
    input.value = "";
    loadFiles(folder);
    setStatus("Created " + path);
    loadFile(path);
  });
}

function insertMarkdown(prefix, suffix) {
  const textarea = document.getElementById("editor");
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const value = textarea.value;
  const selected = value.substring(start, end);
  const newText = value.substring(0, start) + prefix + selected + suffix + value.substring(end);
  textarea.value = newText;
  textarea.focus();
  textarea.selectionStart = start + prefix.length;
  textarea.selectionEnd = end + prefix.length;
  renderPreview();
  dirty = true;
  document.getElementById("autosaveIndicator").textContent = "Autosave: Pending";
}

function insertHeading() {
  const textarea = document.getElementById("editor");
  const start = textarea.selectionStart;
  const value = textarea.value;
  const before = value.substring(0, start);
  const lineStart = before.lastIndexOf("\n") + 1;
  const newValue = value.substring(0, lineStart) + "# " + value.substring(lineStart);
  textarea.value = newValue;
  textarea.focus();
  textarea.selectionStart = start + 2;
  textarea.selectionEnd = start + 2;
  renderPreview();
  dirty = true;
  document.getElementById("autosaveIndicator").textContent = "Autosave: Pending";
}

function insertLink() {
  const url = prompt("Enter URL:");
  if (!url) return;
  insertMarkdown("[", `](${url})`);
}

function insertImage() {
  const url = prompt("Enter image URL:");
  if (!url) return;
  insertMarkdown("![](", `${url})`);
}

function renderPreview() {
  const md = document.getElementById("editor").value;
  document.getElementById("preview").innerHTML = marked.parse(md || "");
}

document.getElementById("editor").addEventListener("input", () => {
  dirty = true;
  renderPreview();
  document.getElementById("autosaveIndicator").textContent = "Autosave: Pending";
});

function startAutosave() {
  if (autosaveTimer) clearInterval(autosaveTimer);
  autosaveTimer = setInterval(() => {
    if (dirty) {
      document.getElementById("autosaveIndicator").textContent = "Autosaving...";
      saveFile();
    }
  }, 8000);
}

function uploadImage() {
  const input = document.getElementById("uploadInput");
  const file = input.files[0];
  if (!file) return;

  const folder = document.getElementById("currentFolder").value || "images";
  const path = folder.replace(/\/$/, "") + "/" + file.name;

  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    const base64 = dataUrl.split(",")[1];

    fetch("/api/upload", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ path, base64 })
    })
    .then(res => res.json())
    .then(data => {
      setStatus("Uploaded " + path);
      loadFiles(folder);
    });
  };
  reader.readAsDataURL(file);
}

// initial load
loadFiles();
renderPreview();
startAutosave();
</script>

</body>
</html>
